###################################################
# Script pour Siril 1.0
# Juillet 2020
# (C) Cyril Richard
# Adapté, modifié et traduit par Colmic
# Couleur_Pre-traitement_AvecDrizzle v1.1
# 
###################################################
#
# Pré-traitement pour Caméra ou APN Couleur
# avec option Drizzle 2x
# 
# Ce script a besoin de 4 dossiers pour fonctionner
# à installer dans votre dossier de travail de Siril :
# offsets, darks, flats, brutes
# Copiez vos images RAW ou FIT dans ces 4 dossiers
# 
# Pensez à prendre vos offsets au même ISO/gain 
# et même temps de pose que vos flats (dark de flat)
#
###################################################

#Création du master-offset (ou dark de flat)
cd offsets
convert offset -out=../process
cd ../process
stack offset rej 3 3 -nonorm
cd ..

#Pré-traitement des flats avec retrait de l'offset (ou du dark de flat)
cd flats
convert flat -out=../process
cd ../process
preprocess flat -dark=offset_stacked

#Création du master-flat
stack pp_flat rej 3 3 -norm=mul
cd ..

#Création du master-dark
cd darks
convert dark -out=../process
cd ../process
stack dark rej 3 3 -nonorm
cd ..

#pré-traitement des brutes
cd brutes
convert brute -out=../process
cd ../process
preprocess brute -dark=dark_stacked -flat=pp_flat_stacked -cfa -equalize_cfa -debayer

#Alignement des brutes avec Drizzle 2x
register pp_brute -drizzle

#Empilement des brutes calibrées
stack r_pp_brute rej 3 3 -norm=addscale -out=../resultat

cd ..
close
